# 核心工具类介绍

##  一、枚举类
位于 `tools/public/enum.py`。
枚举类, 定义项目中使用的常量, 包括日志模块, 操作类型, 页面类型等。
#### 角色数据范围类型
```python
class DataScopeType(pyEnum):
    """数据范围枚举类
    用于定义系统中角色可访问的数据范围类型，主要应用于数据权限控制。

    枚举值说明:
        ALL (1): 全部数据权限 - 可访问所有部门数据
        DEPT_WITH_CHILD (2): 本部门及以下数据 - 可访问所属部门及其子部门数据
        DEPT (3): 本部门数据 - 仅可访问所属部门数据
        CUSTOM (4): 自定义数据权限 - 根据角色配置的特定数据范围访问
    """
```
#### 页面类型
```python
class PageType(pyEnum):
    """ 页面类型枚举类
    定义系统中所有可能的页面类型，用于页面分类和筛选
    """
```

#### 系统模块
```python

class LogModule(pyEnum):
    """
    日志模块枚举类
    定义系统中所有可能的日志记录模块，用于日志分类和筛选
    """
```
#### 操作类型
```python
class OperationType(pyEnum):
    """
    操作类型枚举类
    定义系统中所有可能的操作类型，用于日志分类和筛选
    """
```
## 二、 安全策略
位于 `<mcfile name="password_service.py" path="tools/security/password_service.py"></mcfile>`。
提供了 密码加密,密码校验等
```python
class PasswordService:
    """
    密码服务类
    提供密码加密、校验等功能
    """

    # 单列模型使用
    password_security = PasswordSecurity()
```
## 三、 上下文用户实例 和 权限校验方法

位于: `<mcfile name="login_user.py" path="tools/sys/login_user.py"></mcfile>`
```python


class LoginUser(UserMixin):
    # 添加缓存存储和线程锁
    def __init__(self):
        # 默认属性为空
        self.id = None
        self.user_name = None
        self.name = None
        self.post = None
        self.role_urls = []
        self.is_admin = False
        self.data_scope_type = None
        self.session_token = None
        self.dept_id = None
        self.user = None
        self.avatar = None
    def check_permission(self, permission_tag: str, raise_exception: bool = False):
            """
            权限校验方法

            Args:
                permission_tag: 完整权限标识符 (如user:delete)
                raise_exception: 校验失败时是否抛出异常(默认False)

            Returns:
                bool: 当raise_exception=False时返回校验结果
            """
            if self.is_admin:
                return True
            if self.user:
                return self.user.check_permission(
                    permission_tag=permission_tag, raise_exception=raise_exception
                )
            return False


 ###  使用示例
from flask_login import current_user
# 获取当前登录用户信息
id = current_user.id
is_admin = current_user.is_admin

# 权限校验
permission_tag = "user:delete"
result = current_user.check_permission(permission_tag)
if result:
    print("用户有删除用户的权限")
else:
    print("用户没有删除用户的权限")

```

## 四、 token 生成,校验,解析
位于: `<mcfile name="token_manager.py" path="tools/sys/token_manager.py"></mcfile>`
```python
# token 生成示例
from tools.sys.token_manager import TokenManager
token_manager = TokenManager()
new_session_token = TokenManager.generate_token(match_user.id)


# token解析用户id 示例
user_id = TokenManager.verify_token(new_session_token)
if user_id:
    print(f"校验成功，用户ID: {user_id}")
else:
    print("校验失败")



# 装饰器 校验token 示例
from tools.sys.token_manager import token_required
@app.callback(
    Input("duplicate-login-check-interval", "n_intervals"),
    State("root-url", "pathname"),
)
def duplicate_login_check(n_intervals, pathname):
    """重复登录辅助轮询检查"""

    # 若当前页面属于无需校验登录状态的公共页面，结束检查
    if pathname in route_menu.public_pages:
        return
    # 若当前用户身份未知
    if isinstance(current_user, AnonymousUserMixin):
        # 重定向到登出页
        set_props(
            "global-redirect",
            {"children": dcc.Location(pathname="/logout", id="global-redirect")},
        )




    # 若当前用户已登录
    elif current_user.is_authenticated:
        with get_db() as db:
            match_user = UserService.get_user(db, current_user.id)


        # 若当前回调请求携带cookies中的session_token，当前用户数据库中的最新session_token不一致
        @TokenManager.prevent_duplicate_login
        def check_token():
            pass
        check_token()
```
